<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Menú del sistema</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fuente -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f9fbff; --card:#ffffff; --ink:#0f172a; --muted:#5b6378; --muted2:#8b94a8;
      --brand:#7c3aed; --brand2:#22c55e; --ring:rgba(124,58,237,.25); --divider:#e8ebf3;
      --chipbg:#eef2ff; --chipfg:#3730a3;
      --optbg:#f7f9ff; --optbd:#dfe6fb; --optfg:#0f1a3a;
      --ok:#16a34a; --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(900px 520px at -10% -10%, #efeaff 0%, transparent 55%),
        radial-gradient(900px 520px at 110% 0%, #e9fff5 0%, transparent 50%),
        var(--bg);
      color:var(--ink);
      font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    }
    .wrap{max-width:1120px; margin:22px auto; padding:0 16px}
    header{display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px}
    h1{font-size:clamp(20px,2.6vw,28px); margin:0}
    .userbox{display:flex; align-items:center; gap:10px; font-size:13px; color:var(--muted2)}
    .logout{color:var(--danger); cursor:pointer; text-decoration:underline; font-weight:700}

    .bar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; background:var(--card); padding:12px; border-radius:14px; border:1px solid var(--divider); box-shadow:0 10px 30px rgba(15,23,42,.05)}
    .group{display:flex; flex-direction:column; min-width:220px}
    label{font-size:12px; color:var(--muted); margin-bottom:6px}
    select{
      padding:10px 12px; border-radius:10px; border:1px solid #d5d8e1; background:#fff; color:var(--ink);
      outline:none; font-size:14px; min-width:220px; transition: box-shadow .2s, border-color .2s;
    }
    select:focus{ box-shadow:0 0 0 4px var(--ring); border-color: var(--brand) }

    .grid{ display:grid; grid-template-columns: repeat(12,1fr); gap:16px; margin-top:16px }
    .col-4{ grid-column: span 12 }
    @media (min-width:720px){ .col-4{ grid-column: span 4 } }

    .card{ background:var(--card); border:1px solid var(--divider); border-radius:16px; padding:16px 14px; box-shadow: 0 12px 34px rgba(15,23,42,.06) }
    .menu-title{ margin:0 0 8px; font-size:16px; font-weight:800 }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--chipbg); color:var(--chipfg); font-weight:700; font-size:12px }

    .opts{ margin:10px 0 0; padding:0; list-style:none; display:flex; flex-direction:column; gap:8px }
    .opt{ display:flex; justify-content:space-between; align-items:center; gap:10px; background:var(--optbg); border:1px solid var(--optbd); color:var(--optfg); padding:10px 12px; border-radius:10px }
    .opt-name{font-weight:600; font-size:14px}
    .go{
      appearance:none; border:none; cursor:pointer; padding:8px 12px; border-radius:10px; font-weight:700;
      background:linear-gradient(90deg,var(--brand) 0%, #a855f7 100%); color:#fff;
      box-shadow:0 8px 16px rgba(124,58,237,.25);
    }
    .go[disabled]{opacity:.6; cursor:not-allowed}

    .status{ margin-top:14px; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; color:#475569; font-size:13px; display:none }
    .status.show{ display:block }
    .status.--err{ border-color:#fecaca; background:#fff1f2; color:#991b1b }

    .spinner{width:16px; height:16px; border:2px solid #e2e8f0; border-top-color:#7c3aed; border-radius:50%; display:inline-block; vertical-align:-3px; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Menú</h1>
      <div class="userbox">
        <span id="who"></span> • <span class="logout" id="logout">Salir</span>
      </div>
    </header>

    <section class="bar" id="roleBar" style="display:none">
      <div class="group">
        <label for="role">Rol</label>
        <select id="role">
          <option value="" selected disabled>Selecciona rol…</option>
        </select>
      </div>
    </section>

    <div id="status" class="status"></div>
    <section id="grid" class="grid" aria-live="polite"></section>
  </div>

  <script>
    // ===== Validar login =====
    const saved = sessionStorage.getItem('usuario');
    if (!saved) {
      window.location.href = "login.html";
    }
    const usuario = JSON.parse(saved);

    // ===== Endpoints =====
    const BASE = "http://localhost:8080";
    const API = {
      rolesPorUsuario: (idUsuario) => `${BASE}/roles/por-usuario/${idUsuario}`,
      menusPorRol:     (idRol)      => `${BASE}/rol-menu/menus-por-rol/${idRol}`,
      opcionesPorMenu: (idMenu)     => `${BASE}/opciones/por-menu/${idMenu}`,
      modulos:                      `${BASE}/modulos`
    };

    // ===== DOM =====
    const who = document.getElementById('who');
    const logout = document.getElementById('logout');
    const status = document.getElementById('status');
    const grid = document.getElementById('grid');
    const roleBar = document.getElementById('roleBar');
    const selRole = document.getElementById('role');

    who.textContent = `Usuario: ${usuario.nombreUsuario}`;
    logout.addEventListener('click', ()=> {
      sessionStorage.removeItem('usuario');
      window.location.href="login.html";
    });

    // ===== Helpers =====
    const show = (msg, err=false) => {
      if(!msg){ status.className='status'; status.textContent=''; status.style.display='none'; return; }
      status.textContent = msg;
      status.className = 'status show' + (err ? ' --err' : '');
    };
    const clear = (el) => el.innerHTML = '';
    const fillSelect = (el, items, getValue, getLabel, placeholder='Selecciona…') => {
      el.innerHTML = '';
      const head = document.createElement('option');
      head.value=''; head.disabled=true; head.selected=true; head.textContent = placeholder;
      el.appendChild(head);
      for (const it of items) {
        const opt = document.createElement('option');
        opt.value = getValue(it);
        opt.textContent = getLabel(it);
        el.appendChild(opt);
      }
    };
    const jget = async (url) => { const r = await fetch(url); if (!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`); return r.json(); };

    // ===== Datos =====
    let roles = [];
    let moduloById = new Map();

    async function init(){
      try {
        show('Cargando roles…');
        roles = await jget(API.rolesPorUsuario(usuario.idUsuario));

        if (!roles || roles.length===0){
          show('El usuario no tiene roles asignados.', true);
          return;
        }

        try {
          const mods = await jget(API.modulos);
          moduloById = new Map(mods.map(m => [m.idModulo, m.nombre]));
        } catch { /* no crítico */ }

        const rolAdmin = roles.find(r => (r.nombreRol || r.nombre || '').toUpperCase() === 'ADMINISTRADOR');
        const rolElegido = rolAdmin || roles[0];

        if (!rolAdmin && roles.length > 1) {
          roleBar.style.display = 'flex';
          fillSelect(selRole, roles, r=>r.idRol, r=>r.nombreRol || r.nombre, 'Selecciona rol…');
          selRole.value = rolElegido.idRol;
          selRole.addEventListener('change', ()=> cargarMenusPorRol(Number(selRole.value)));
        }

        await cargarMenusPorRol(rolElegido.idRol);
        show('');
      } catch (e) {
        console.error(e);
        show('No fue posible cargar roles/menús. Revisa los endpoints y datos.', true);
      }
    }

    async function cargarMenusPorRol(idRol){
      show('Cargando menús…');
      clear(grid);
      try{
        const menus = await jget(API.menusPorRol(idRol));
        if (!menus || menus.length===0){
          show('Este rol no tiene menús asignados.', true);
          return;
        }

        for (const menu of menus) {
          const opciones = await jget(API.opcionesPorMenu(menu.idMenu)).catch(()=>[]);
          pintarTarjetaMenu(menu, opciones);
        }
        show('');
      }catch(e){
        console.error(e);
        show('Error al cargar menús/opciones.', true);
      }
    }

    function pintarTarjetaMenu(menu, opciones){
      const col = document.createElement('article');
      col.className = 'col-4';

      const card = document.createElement('div');
      card.className = 'card';

      const title = document.createElement('h3');
      title.className = 'menu-title';
      title.textContent = menu.nombreMenu ?? 'Menú';
      card.appendChild(title);

      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = moduloById.get(menu.idModulo) || `Módulo ${menu.idModulo ?? ''}`.trim();
      card.appendChild(chip);

      const ul = document.createElement('ul'); ul.className='opts';

      if (opciones && opciones.length){
        for (const op of opciones) {
          const li = document.createElement('li'); li.className='opt';
          const span = document.createElement('span'); span.className='opt-name'; span.textContent = op.nombreOpcion ?? op.nombre ?? 'Opción';
          const btn = document.createElement('button'); btn.className='go'; btn.textContent='Ir';
          const ruta = op.rutaHtml ?? op.ruta ?? op.url ?? null;
          if (ruta){
            btn.addEventListener('click', ()=> window.location.href = ruta);
          } else {
            btn.disabled = true; btn.title = 'Sin ruta configurada';
          }
          li.append(span, btn); ul.appendChild(li);
        }
      } else {
        const li = document.createElement('li'); li.className='opt';
        const span = document.createElement('span'); span.className='opt-name'; span.textContent='Sin opciones';
        const btn = document.createElement('button'); btn.className='go'; btn.textContent='Ir'; btn.disabled=true;
        li.append(span, btn); ul.appendChild(li);
      }

      card.appendChild(ul);
      col.appendChild(card);
      grid.appendChild(col);
    }

    init();
  </script>
</body>
</html>
