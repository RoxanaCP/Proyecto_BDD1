<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Facturación a clientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{--bg:#f6f7fb;--panel:#fff;--ink:#0f172a;--muted:#6b7280;--border:#e5e7eb;--brand:#7c3aed;--ring:rgba(124,58,237,.25)}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .btn-link{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;text-decoration:none;font-weight:600}
    h1{margin:0;font-size:clamp(20px,2.6vw,28px)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 12px 34px rgba(15,23,42,.06);margin-bottom:14px}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(12,1fr)}
    .col-6{grid-column:span 12} @media(min-width:800px){.col-6{grid-column:span 6}}
    label{display:block;font-size:13px;color:#334155;margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;outline:none}
    input:focus,select:focus{box-shadow:0 0 0 4px var(--ring);border-color:#7c3aed}
    .row{display:flex;gap:8px;align-items:end}
    .btn{appearance:none;border:none;cursor:pointer;padding:10px 14px;border-radius:10px;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,#7c3aed 0%, #a855f7 100%);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--border)}
    .btn.danger{background:#fff;border:1px solid #fecaca;color:#991b1b}
    .status{margin:10px 0;padding:10px 12px;border-radius:10px;border:1px solid var(--border);display:none;white-space:pre-line}
    .status.err{display:block;color:#991b1b;background:#fff1f2;border-color:#fecaca}
    .status.ok{display:block;color:#065f46;background:#ecfdf5;border-color:#bbf7d0}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    tfoot td{font-weight:700}
    .right{text-align:right}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <a href="menu.html" class="btn-link">⬅ Menú</a>
    <h1>Facturación</h1>
    <span></span>
  </header>

  <div id="msg" class="status"></div>

  <!-- Cliente -->
  <section class="card">
    <h3 style="margin:0 0 10px">Cliente</h3>
    <div class="grid">
      <div class="col-6">
        <label for="idCliente">ID Cliente</label>
        <div class="row">
          <input id="idCliente" type="number" placeholder="Ej.: 10" />
          <button class="btn ghost" type="button" id="btnBuscarCliente">Buscar</button>
        </div>
      </div>
      <div class="col-6">
        <label>Datos</label>
        <div class="card" style="padding:10px">
          <div><strong>Nombre:</strong> <span id="cliNombre">—</span></div>
          <div><strong>Teléfono:</strong> <span id="cliTel">—</span></div>
          <div class="muted"><strong>NIT:</strong> <span id="cliNit">—</span> • <strong>Email:</strong> <span id="cliEmail">—</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Encabezado -->
  <section class="card">
    <h3 style="margin:0 0 10px">Encabezado</h3>
    <div class="grid">
      <div class="col-6">
        <label for="idTipoVenta">Tipo de venta</label>
        <select id="idTipoVenta"><option value="" disabled selected>Seleccione…</option></select>
      </div>
      <div class="col-6">
        <label for="idTipoPago">Tipo de pago</label>
        <select id="idTipoPago"><option value="" disabled selected>Seleccione…</option></select>
      </div>
    </div>
  </section>

  <!-- Detalle -->
  <section class="card">
    <h3 style="margin:0 0 10px">Detalle</h3>
    <div class="grid">
      <div class="col-6">
        <label for="idProducto">Producto</label>
        <select id="idProducto"><option value="" disabled selected>Seleccione…</option></select>
      </div>
      <div class="col-6">
        <label for="cantidad">Cantidad</label>
        <div class="row">
          <input id="cantidad" type="number" min="1" step="1" placeholder="1" />
          <button class="btn ghost" type="button" id="btnAgregar">Agregar producto</button>
        </div>
      </div>
    </div>

    <table>
      <thead>
        <tr><th>Producto</th><th class="right">Cantidad</th><th class="right">Acciones</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr><td>Total (ref)</td><td class="right" id="tdTotal">0</td><td></td></tr>
      </tfoot>
    </table>
  </section>

  <div style="display:flex; justify-content:flex-end; gap:8px">
    <button class="btn primary" type="button" id="btnCrear">Crear factura</button>
  </div>
</div>

<script>
  // ===== Ajusta si tu app tiene context-path
  const BASE = "";
  const API = {
    clienteVista: (id) => `${BASE}/clientes/${id}/vista`,
    tipoVenta:    `${BASE}/tipo-venta`,
    tipoPago:     `${BASE}/tipo-pago`,
    productos:    `${BASE}/productos`,
    crearVenta:   `${BASE}/ventas/crear`
  };

  // Estado UI
  const msg = document.getElementById('msg');
  const tbody = document.getElementById('tbody');
  const tdTotal = document.getElementById('tdTotal');

  const productosMap = new Map(); // id -> {idProducto, nombre}
  let detalle = []; // [{idProducto, cantidad}]

  function showOk(t){ msg.textContent=t; msg.className='status ok'; }
  function showErr(t){ msg.textContent=t; msg.className='status err'; }
  function clearMsg(){ msg.textContent=''; msg.className='status'; }

  function getEmpleadoSesion(){
    try{ return JSON.parse(sessionStorage.getItem('empleado') || '{}'); }
    catch{ return {}; }
  }

  async function jget(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`);
    return r.json();
  }

  function renderDetalle(){
    tbody.innerHTML = '';
    let total = 0;
    detalle.forEach((row, i) => {
      const prod = productosMap.get(row.idProducto);
      total += row.cantidad;

      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = prod ? prod.nombre : row.idProducto;
      const td2 = document.createElement('td'); td2.className='right'; td2.textContent = row.cantidad;
      const td3 = document.createElement('td'); td3.className='right';
      const btnDel = document.createElement('button');
      btnDel.className = 'btn danger'; btnDel.textContent = 'Quitar';
      btnDel.onclick = () => { detalle.splice(i,1); renderDetalle(); };
      td3.appendChild(btnDel);

      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
      tbody.appendChild(tr);
    });
    tdTotal.textContent = total;
  }

  // --- EXTRACTOR DE ERRORES (mejorado) ---
  function extraerMensajeError(raw) {
  if (!raw) return '';
  try {
    const j = JSON.parse(raw);
    if (j?.message) return j.message;
  } catch {}
  const m = raw.match(/ORA-(2000\d):\s*([^\n\r]+)/); // solo mensajes funcionales 2000x
  if (m) return m[2].trim();
  return 'Ocurrió un error al procesar la solicitud.'; // fallback
}


  async function crearFactura(payload, headers) {
    const r = await fetch(API.crearVenta, { method:'POST', headers, body: JSON.stringify(payload) });
    if (!r.ok) {
      let text = '';
      try { text = await r.text(); } catch(_) {}
      const limpio = extraerMensajeError(text);
      showErr(limpio || `Error HTTP ${r.status}`);
      return null;
    }
    return r.json();
  }

  // Carga inicial catálogos
  (async function init(){
    try{
      clearMsg();
      const [ventas, pagos, prods] = await Promise.all([
        jget(API.tipoVenta).catch(()=>[]),
        jget(API.tipoPago).catch(()=>[]),
        jget(API.productos).catch(()=>[])
      ]);

      const selVenta = document.getElementById('idTipoVenta');
      const selPago  = document.getElementById('idTipoPago');
      const selProd  = document.getElementById('idProducto');

      for(const v of ventas){ const o=document.createElement('option'); o.value=v.idTipoVenta; o.textContent=v.descripcion; selVenta.appendChild(o); }
      for(const p of pagos){ const o=document.createElement('option'); o.value=p.idTipoPago;  o.textContent=p.descripcion; selPago.appendChild(o); }
      for(const p of prods){
        const o=document.createElement('option'); o.value=p.idProducto;  o.textContent=p.nombre; selProd.appendChild(o);
        productosMap.set(p.idProducto, p);
      }
    }catch(e){
      console.error(e);
      showErr('No fue posible cargar catálogos.');
    }
  })();

  // Buscar cliente
  document.getElementById('btnBuscarCliente').addEventListener('click', async ()=>{
    const id = Number(document.getElementById('idCliente').value);
    if(!id){ showErr('Ingresa un ID de cliente.'); return; }
    try{
      clearMsg();
      const c = await jget(API.clienteVista(id)); // {idCliente, nombrePersona, telefono, nit, email}
      document.getElementById('cliNombre').textContent = c.nombrePersona ?? '(sin nombre)';
      document.getElementById('cliTel').textContent    = c.telefono ?? '—';
      document.getElementById('cliNit').textContent    = c.nit ?? '—';
      document.getElementById('cliEmail').textContent  = c.email ?? '—';
      showOk('Cliente cargado.');
    }catch(e){
      console.error(e);
      document.getElementById('cliNombre').textContent = 'No encontrado';
      document.getElementById('cliTel').textContent    = '—';
      document.getElementById('cliNit').textContent    = '—';
      document.getElementById('cliEmail').textContent  = '—';
      showErr('Cliente no encontrado.');
    }
  });

  // Agregar producto
  document.getElementById('btnAgregar').addEventListener('click', ()=>{
    clearMsg();
    const idProducto = Number(document.getElementById('idProducto').value);
    const cantidad   = Number(document.getElementById('cantidad').value);

    if(!idProducto){ showErr('Selecciona un producto.'); return; }
    if(!cantidad || cantidad <= 0){ showErr('Cantidad inválida.'); return; }

    const idx = detalle.findIndex(x => x.idProducto === idProducto);
    if (idx >= 0) detalle[idx].cantidad += cantidad;
    else detalle.push({ idProducto, cantidad });

    renderDetalle();
  });

  // Crear factura (requiere empleado en sesión)
  document.getElementById('btnCrear').addEventListener('click', async ()=>{
    clearMsg();

    const idCliente   = Number(document.getElementById('idCliente').value);
    const idTipoVenta = Number(document.getElementById('idTipoVenta').value);
    const idTipoPago  = Number(document.getElementById('idTipoPago').value);
    const emp         = getEmpleadoSesion();

    if(!idCliente || !idTipoVenta || !idTipoPago){
      showErr('Completa cliente, tipo de venta y tipo de pago.');
      return;
    }
    if(detalle.length === 0){
      showErr('Agrega al menos un producto.');
      return;
    }
    if (!emp.idEmpleado){
      showErr('No hay empleado en sesión. Inicia sesión primero.');
      return;
    }

    const headers = {
      'Content-Type': 'application/json',
      'X-Empleado-Id': String(emp.idEmpleado)
    };

    const payload = {
      idCliente,
      idTipoVenta,
      idTipoPago,
      detalle: detalle.map(d => ({ idProducto: d.idProducto, cantidad: d.cantidad }))
    };

    const data = await crearFactura(payload, headers);
    if (!data) return; // ya mostramos el error
    showOk(data.mensaje || `Factura creada (ID ${data.idFactura || 'N/D'})`);
    detalle = []; renderDetalle();
  });

  // ---- Ayuda dev opcional (descomenta para simular sesión) ----
  // if (!sessionStorage.getItem('empleado')) {
  //   sessionStorage.setItem('empleado', JSON.stringify({ idEmpleado: 1 }));
  // }
</script>
</body>
</html>
