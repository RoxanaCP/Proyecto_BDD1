<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Registro de Movimiento de Inventario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fuente personalizada -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Tema CLARO con acentos violeta/magenta */
      --bg:#f6f7fb;
      --panel:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --border:#e5e7eb;
      --accent:#a855f7;
      --accent-2:#ec4899;
      --ring: rgba(168,85,247,.28);
      --btn-text:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100dvh; display:grid; place-items:center;
      background: radial-gradient(1000px 600px at 18% -12%, #eef0fb 0%, var(--bg) 55%);
      color:var(--text);
      font-family:"Poppins", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    .card{
      width:min(980px,94vw);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:20px; padding:26px;
      box-shadow:0 20px 60px rgba(16,24,40,.08), 0 2px 6px rgba(16,24,40,.06);
    }
    h1{margin:0 0 6px; font-size:clamp(22px,3.2vw,30px); letter-spacing:.2px; font-weight:600}
    form{display:grid; gap:18px; margin-top:10px}
    .grid{display:grid; gap:16px; grid-template-columns:repeat(12,1fr)}
    .field{grid-column:span 12; display:flex; flex-direction:column; gap:8px}
    @media (min-width:720px){ .span-6{grid-column:span 6} .span-4{grid-column:span 4} .span-8{grid-column:span 8} }
    label{font-size:13px; color:#334155}
    select,input[type="number"]{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid var(--border); background:#fff; color:var(--text);
      outline:none; font-size:15px; transition:border .2s, box-shadow .2s, background .2s;
    }
    select:hover,input:hover{background:#fafafa}
    select:focus,input:focus{border-color:var(--accent); box-shadow:0 0 0 4px var(--ring)}
    .actions{display:flex; gap:12px; justify-content:flex-end; margin-top:8px}
    .btn{appearance:none; border:none; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:600; letter-spacing:.2px}
    .btn-secondary{background:#ffffff; color:#111827; border:1px solid var(--border)}
    .btn-primary{
      background:linear-gradient(90deg,var(--accent) 0%, var(--accent-2) 100%);
      color:var(--btn-text);
      box-shadow:0 8px 20px rgba(168,85,247,.25);
    }
    .toast{
      padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#fff; color:#475569; font-size:13px;
      display:none; align-items:center; gap:8px; /* oculto por defecto */
      margin-top:10px;
    }
    .toast.--show{display:inline-flex}
    .toast.--error{border-color:#fecaca; color:#991b1b; background:#fff0f0}
  </style>
</head>
<body>
  <main class="card" role="main">
    <h1>Movimiento de Inventario</h1>

    <!-- Solo aparece en caso de error -->
    <div id="status" class="toast --error"></div>

    <!-- FORM -->
    <form action="/movimientos-inventario/crear" method="post" novalidate>
      <div class="grid">
        <!-- País -->
        <div class="field span-6">
          <label for="idpais">País</label>
          <select id="idpais" required>
            <option value="" selected disabled>Selecciona país…</option>
          </select>
        </div>

        <!-- Centro Comercial -->
        <div class="field span-6">
          <label for="idcc">Centro Comercial</label>
          <select id="idcc" disabled required>
            <option value="" selected disabled>Selecciona centro comercial…</option>
          </select>
        </div>

        <!-- Sucursal -->
        <div class="field span-6">
          <label for="idsucursal">Sucursal</label>
          <select id="idsucursal" disabled required>
            <option value="" selected disabled>Selecciona sucursal…</option>
          </select>
        </div>

        <!-- Bodega -->
        <div class="field span-6">
          <label for="idbodega">Bodega</label>
          <select id="idbodega" name="IDBODEGA" disabled required>
            <option value="" selected disabled>Selecciona bodega…</option>
          </select>
        </div>

        <!-- Tipo de movimiento -->
        <div class="field span-6">
          <label for="idtipomovimiento">Tipo de movimiento</label>
          <select id="idtipomovimiento" name="IDTIPOMOVIMIENTO" required>
            <option value="" selected disabled>Selecciona tipo…</option>
            <option value="1">INGRESO</option>
            <option value="2">EGRESO</option>
          </select>
        </div>

        <!-- Producto (opcional) -->
        <div class="field span-8">
          <label for="idproducto">Producto</label>
          <select id="idproducto" name="IDPRODUCTO" required>
            <option value="" selected disabled>Selecciona producto…</option>
          </select>
        </div>

        <!-- Cantidad -->
        <div class="field span-4">
          <label for="cantidad">Cantidad</label>
          <input type="number" id="cantidad" name="CANTIDADPRODUCTO" min="1" step="1" placeholder="Ej.: 30" required />
        </div>
      </div>

      <div class="actions">
        <button type="reset" class="btn btn-secondary">Limpiar</button>
        <button type="submit" class="btn btn-primary">Guardar movimiento</button>
      </div>
    </form>
  </main>

  <script>
    // Ajusta si usas context-path, p. ej. "/venta"
    const BASE_URL = ""; // "" si el context-path es '/', o "/venta" si configuraste server.servlet.context-path=/venta
    const API = {
      paises: BASE_URL + "/pais",
      centros: BASE_URL + "/centros-comerciales",
      sucursales: BASE_URL + "/sucursales",
      bodegas: BASE_URL + "/bodegas",
      productos: BASE_URL + "/productos" // opcional
    };

    // DOM
    const selPais = document.getElementById('idpais');
    const selCC   = document.getElementById('idcc');
    const selSuc  = document.getElementById('idsucursal');
    const selBod  = document.getElementById('idbodega');
    const selProd = document.getElementById('idproducto');
    const status  = document.getElementById('status');

    // helpers
    const setDisabled = (el, on) => { el.disabled = on; if (on) el.value = ""; };
    const clearOptions = (el, placeholder='Selecciona…') => {
      el.innerHTML = '';
      const o = document.createElement('option');
      o.value=''; o.disabled=true; o.selected=true; o.textContent=placeholder;
      el.appendChild(o);
    };
    const fillOptions = (el, items, getValue, getLabel, placeholder='Selecciona…') => {
      clearOptions(el, placeholder);
      for (const it of items) {
        const opt = document.createElement('option');
        opt.value = getValue(it);
        opt.textContent = getLabel(it);   // etiquetas sin numeración
        el.appendChild(opt);
      }
    };
    async function jget(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status} en ${url}`);
      return r.json();
    }
    function showError(msg){
      status.textContent = msg;
      status.classList.add('--show');
    }

    // cache
    let cache = { paises:[], centros:[], sucursales:[], bodegas:[], productos:[] };

    // init load
    (async function init(){
      try{
        const [paises, centros, sucursales, bodegas] = await Promise.all([
          jget(API.paises), jget(API.centros), jget(API.sucursales), jget(API.bodegas)
        ]);

        let productos = [];
        try { productos = await jget(API.productos); } catch { /* opcional */ }

        cache = {paises, centros, sucursales, bodegas, productos};

        // Países
        fillOptions(selPais, cache.paises, x=>x.idPais, x=>x.nombre, 'Selecciona país…');
        setDisabled(selCC, true); setDisabled(selSuc, true); setDisabled(selBod, true);

        // Productos si hay endpoint
        if (cache.productos && cache.productos.length) {
          fillOptions(selProd, cache.productos, p=>p.idProducto, p=>p.nombre, 'Selecciona producto…');
        } else {
          clearOptions(selProd, 'Selecciona producto…');
        }

        if(!paises.length) showError('Sin datos en Países. Inserta filas en la BD.');
      }catch(e){
        console.error(e);
        showError('No se pudieron cargar catálogos. Verifica /pais, /centros-comerciales, /sucursales y /bodegas.');
      }
    })();

    // cascada
    selPais.addEventListener('change', () => {
      const idPais = Number(selPais.value);

      // Centros que tienen alguna sucursal en ese país
      const centrosDelPais = Array.from(new Set(
        cache.sucursales.filter(s => s.idPais === idPais).map(s => s.idCentroComercial)
      ))
      .map(idCC => cache.centros.find(c => c.idCentroComercial === idCC))
      .filter(Boolean);

      fillOptions(selCC, centrosDelPais, c=>c.idCentroComercial, c=>c.nombre, 'Selecciona centro comercial…');
      setDisabled(selCC, centrosDelPais.length === 0);

      clearOptions(selSuc,'Selecciona sucursal…'); setDisabled(selSuc,true);
      clearOptions(selBod,'Selecciona bodega…'); setDisabled(selBod,true);
    });

    selCC.addEventListener('change', () => {
      const idPais = Number(selPais.value);
      const idCC = Number(selCC.value);

      const sucFiltradas = cache.sucursales.filter(s => s.idPais === idPais && s.idCentroComercial === idCC);
      fillOptions(selSuc, sucFiltradas, s=>s.idSucursal, s=>s.nombre, 'Selecciona sucursal…');
      setDisabled(selSuc, sucFiltradas.length === 0);

      clearOptions(selBod,'Selecciona bodega…'); setDisabled(selBod,true);
    });

    selSuc.addEventListener('change', () => {
      const idSucursal = Number(selSuc.value);
      const bod = cache.bodegas.filter(b => b.idSucursal === idSucursal);
      fillOptions(selBod, bod, b=>b.idBodega, b=> (b.direccion ?? 'Bodega'), 'Selecciona bodega…');
      setDisabled(selBod, bod.length === 0);
    });
  </script>
</body>
</html>
