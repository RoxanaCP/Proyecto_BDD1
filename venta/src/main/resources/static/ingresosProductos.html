<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Movimiento de Inventario</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg:#f6f7fb; --panel:#fff; --text:#0f172a; --muted:#6b7280;
    --border:#e5e7eb; --accent:#7c3aed; --accent-2:#a855f7; --ring:rgba(124,58,237,.25);
    --btn-text:#fff;
  }
  *{box-sizing:border-box;}
  body{
    margin:0; font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1000px 600px at 18% -12%, #eef0fb 0%, var(--bg) 55%);
    color: var(--text); padding:20px;
  }
  .card{
    max-width:980px; width:94vw; margin:0 auto;
    background: var(--panel); border:1px solid var(--border); border-radius:18px;
    padding:24px; box-shadow:0 16px 46px rgba(16,24,40,.08),0 2px 6px rgba(16,24,40,.06);
  }
  .topbar{
    display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;
  }
  h1{margin:0; font-size:clamp(22px,3vw,28px); font-weight:600; color:var(--accent);}
  .btn-menu{
    display:inline-flex; align-items:center; gap:6px; padding:10px 14px;
    border-radius:12px; border:none; background:linear-gradient(90deg,var(--accent) 0%,var(--accent-2) 100%);
    color:#fff; font-weight:600; text-decoration:none; box-shadow:0 8px 20px rgba(124,58,237,.25);
  }
  .btn-menu:active{transform:translateY(1px);}
  form{display:grid; gap:18px; margin-top:10px;}
  .grid{display:grid; gap:14px; grid-template-columns:repeat(12,1fr);}
  .field{display:flex; flex-direction:column; gap:6px; grid-column:span 12;}
  @media(min-width:720px){.span-6{grid-column:span 6;} .span-4{grid-column:span 4;} .span-8{grid-column:span 8;}}
  label{font-size:13px; color:#334155;}
  select,input[type="number"]{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
    background:#fff; outline:none; font-size:15px; transition:.2s; color: var(--text);
  }
  select:hover,input:hover{background:#fafafa;}
  select:focus,input:focus{border-color:var(--accent); box-shadow:0 0 0 4px var(--ring);}
  .actions{display:flex; gap:12px; justify-content:flex-end; margin-top:12px;}
  .btn{border:none; cursor:pointer; border-radius:12px; padding:10px 16px; font-weight:600; transition:.2s;}
  .btn-primary{background:linear-gradient(90deg,var(--accent) 0%, var(--accent-2) 100%); color:var(--btn-text); box-shadow:0 8px 20px rgba(124,58,237,.25);}
  .btn-primary:hover{opacity:.9;}
  .btn-secondary{background:#fff; border:1px solid var(--border); color:var(--text);}
  .btn[disabled]{opacity:.7; cursor:not-allowed;}
  .toast{
    display:none; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
    font-size:13px; margin-top:10px;
  }
  .toast.--show{display:inline-flex;}
  .toast.--ok{border-color:#bbf7d0; color:#065f46; background:#ecfdf5;}
  .toast.--error{border-color:#fecaca; color:#991b1b; background:#fff1f2;}
</style>
</head>
<body>
<main class="card">
  <div class="topbar">
    <a href="menu.html" class="btn-menu">⬅ Menú</a>
    <h1>Movimiento de Inventario</h1>
    <span></span>
  </div>

  <div id="status" class="toast"></div>

  <form id="formMov" novalidate>
    <div class="grid">
      <div class="field span-6">
        <label for="idpais">País</label>
        <select id="idpais" required>
          <option value="" selected disabled>Selecciona país…</option>
        </select>
      </div>
      <div class="field span-6">
        <label for="idcc">Centro Comercial</label>
        <select id="idcc" disabled required>
          <option value="" selected disabled>Selecciona centro comercial…</option>
        </select>
      </div>
      <div class="field span-6">
        <label for="idsucursal">Sucursal</label>
        <select id="idsucursal" disabled required>
          <option value="" selected disabled>Selecciona sucursal…</option>
        </select>
      </div>
      <div class="field span-6">
        <label for="idbodega">Bodega</label>
        <select id="idbodega" disabled required>
          <option value="" selected disabled>Selecciona bodega…</option>
        </select>
      </div>
      <div class="field span-6">
        <label for="idtipomovimiento">Tipo de movimiento</label>
        <select id="idtipomovimiento" required>
          <option value="" selected disabled>Selecciona tipo…</option>
          <option value="1">INGRESO</option>
          <option value="2">EGRESO</option>
        </select>
      </div>
      <div class="field span-8">
        <label for="idproducto">Producto</label>
        <select id="idproducto" required>
          <option value="" selected disabled>Selecciona producto…</option>
        </select>
      </div>
      <div class="field span-4">
        <label for="cantidad">Cantidad</label>
        <input type="number" id="cantidad" min="1" step="1" placeholder="Ej.: 30" required/>
      </div>
    </div>
    <div class="actions">
      <button type="reset" class="btn btn-secondary">Limpiar</button>
      <button type="submit" id="btnGuardar" class="btn btn-primary">Guardar movimiento</button>
    </div>
  </form>
</main>

<script>
  const usuario = sessionStorage.getItem("usuario");
  if(!usuario){ window.location.href="login.html"; }

  const BASE_URL = "";
  const API = {
    paises: BASE_URL+"/pais",
    centros: BASE_URL+"/centros-comerciales",
    sucursales: BASE_URL+"/sucursales",
    bodegas: BASE_URL+"/bodegas",
    productos: BASE_URL+"/productos",
    crearMov: BASE_URL+"/movimientos-inventario/crear"
  };

  const selPais = document.getElementById('idpais');
  const selCC = document.getElementById('idcc');
  const selSuc = document.getElementById('idsucursal');
  const selBod = document.getElementById('idbodega');
  const selProd = document.getElementById('idproducto');
  const status = document.getElementById('status');
  const form = document.getElementById('formMov');
  const btnGuardar = document.getElementById('btnGuardar');

  const setDisabled = (el,on)=>{ el.disabled=on; if(on) el.value=""; };
  const clearOptions = (el,placeholder='Selecciona…')=>{
    el.innerHTML=''; const o=document.createElement('option');
    o.value=''; o.disabled=true; o.selected=true; o.textContent=placeholder; el.appendChild(o);
  };
  const fillOptions = (el,items,getValue,getLabel,placeholder='Selecciona…')=>{
    clearOptions(el,placeholder);
    for(const it of items){ const opt=document.createElement('option'); opt.value=getValue(it); opt.textContent=getLabel(it); el.appendChild(opt);}
  };
  async function jget(url){ const r=await fetch(url); if(!r.ok) throw new Error(`HTTP ${r.status} en ${url}`); return r.json(); }
  function showError(msg){ status.textContent=msg; status.className='toast --show --error'; }
  function showOk(msg){ status.textContent=msg; status.className='toast --show --ok'; }
  function clearMsg(){ status.textContent=''; status.className='toast'; }

  let cache={paises:[], centros:[], sucursales:[], bodegas:[], productos:[]};

  (async function init(){
    try{
      const [paises, centros, sucursales, bodegas] = await Promise.all([jget(API.paises),jget(API.centros),jget(API.sucursales),jget(API.bodegas)]);
      let productos=[];
      try{ productos=await jget(API.productos);}catch{}
      cache={paises, centros, sucursales, bodegas, productos};
      fillOptions(selPais, cache.paises,x=>x.idPais,x=>x.nombre);
      setDisabled(selCC,true); setDisabled(selSuc,true); setDisabled(selBod,true);
      if(productos.length){ fillOptions(selProd,productos,p=>p.idProducto,p=>p.nombre);} else { clearOptions(selProd);}
    }catch(e){ console.error(e); showError('No se pudieron cargar catálogos.'); }
  })();

  selPais.addEventListener('change',()=>{
    const idPais=Number(selPais.value);
    const centrosDelPais=Array.from(new Set(cache.sucursales.filter(s=>s.idPais===idPais).map(s=>s.idCentroComercial)))
      .map(idCC=>cache.centros.find(c=>c.idCentroComercial===idCC)).filter(Boolean);
    fillOptions(selCC,centrosDelPais,c=>c.idCentroComercial,c=>c.nombre);
    setDisabled(selCC, centrosDelPais.length===0);
    clearOptions(selSuc); setDisabled(selSuc,true);
    clearOptions(selBod); setDisabled(selBod,true);
  });

  selCC.addEventListener('change',()=>{
    const idPais=Number(selPais.value); const idCC=Number(selCC.value);
    const sucFiltradas=cache.sucursales.filter(s=>s.idPais===idPais && s.idCentroComercial===idCC);
    fillOptions(selSuc,sucFiltradas,s=>s.idSucursal,s=>s.nombre);
    setDisabled(selSuc,sucFiltradas.length===0);
    clearOptions(selBod); setDisabled(selBod,true);
  });

  selSuc.addEventListener('change',()=>{
    const idSucursal=Number(selSuc.value);
    const bod=cache.bodegas.filter(b=>b.idSucursal===idSucursal);
    fillOptions(selBod,bod,b=>b.idBodega,b=>b.direccion??'Bodega');
    setDisabled(selBod,bod.length===0);
  });

  form.addEventListener('submit',async(e)=>{
    e.preventDefault(); clearMsg();
    const idBodega=Number(selBod.value);
    const idTipoMovimiento=Number(document.getElementById('idtipomovimiento').value);
    const idProducto=Number(selProd.value);
    const cantidad=Number(document.getElementById('cantidad').value);
    if(!idBodega||!idTipoMovimiento||!idProducto||!cantidad){ showError('Completa todos los campos requeridos.'); return; }

    let idUsuario=null;
    try{ const stored=sessionStorage.getItem('usuario'); if(stored){ idUsuario=JSON.parse(stored).idUsuario??null; } }catch{}

    const payload={idBodega,idTipoMovimiento,idProducto,cantidad,idUsuario};
    const originalText=btnGuardar.textContent; btnGuardar.disabled=true; btnGuardar.textContent='Guardando…';
    try{
      const r=await fetch(API.crearMov,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok){ const txt=await r.text(); showError(txt||`Error HTTP ${r.status}`); return; }
      const data=await r.json(); showOk(data.mensaje||`Movimiento creado (ID ${data.idMovimiento}).`); document.getElementById('cantidad').value=''; document.getElementById('cantidad').focus();
    }catch(err){ console.error(err); showError('No se pudo conectar con el servidor.'); }
    finally{ btnGuardar.disabled=false; btnGuardar.textContent=originalText; }
  });
</script>
</body>
</html>
