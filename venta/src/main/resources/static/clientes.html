<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clientes</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f4f0fa;
      font-family: 'Poppins', sans-serif;
      color: #3a2b5f;
      padding: 40px;
    }

    .card {
      background-color: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(93, 70, 178, 0.2);
      padding: 30px;
      margin-top: 20px;
      border: 1px solid #e0d6f9;
    }

    h2 {
      font-weight: 600;
      color: #4a2ea5;
      margin-bottom: 20px;
    }

    table {
      margin-top: 15px;
      border-collapse: separate;
      border-spacing: 0 10px;
      width: 100%;
    }

    th {
      background-color: #ede5ff;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.5px;
      color: #4a2ea5;
    }

    td, th {
      padding: 12px 15px;
      vertical-align: middle;
    }

    tr {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(93, 70, 178, 0.1);
      transition: all 0.2s;
    }

    tr:hover {
      transform: scale(1.01);
      box-shadow: 0 4px 12px rgba(93, 70, 178, 0.15);
    }

    .btn-primary {
      background-color: #6f42c1;
      border: none;
      border-radius: 10px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .btn-primary:hover {
      background-color: #5a33a3;
    }

    .btn-success {
      background-color: #a47de8;
      border: none;
      border-radius: 10px;
      font-weight: 500;
      color: white;
      transition: background-color 0.2s;
    }

    .btn-success:hover {
      background-color: #8f65d9;
    }

    .btn-secondary {
      background-color: #cbb9f6;
      border: none;
      color: #3a2b5f;
    }

    .btn-menu {
      background-color: #4a2ea5;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 8px 18px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-menu:hover {
      background-color: #372182;
    }

    .modal-content {
      border-radius: 20px;
      border: 1px solid #d8c9fa;
      box-shadow: 0 4px 16px rgba(93, 70, 178, 0.2);
    }

    .modal-header {
      background-color: #ede5ff;
      color: #4a2ea5;
      border-bottom: none;
    }

    .form-label {
      color: #4a2ea5;
      font-weight: 500;
    }

    input, select {
      border-radius: 8px !important;
      border: 1px solid #cbb9f6 !important;
    }

    input:focus, select:focus {
      border-color: #8f65d9 !important;
      box-shadow: 0 0 0 0.2rem rgba(143, 101, 217, 0.25);
    }

    .text-muted {
      color: #6c5ba7 !important;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Clientes registrados</h2>
    <button class="btn-menu" onclick="location.href='menu.html'">‚¨Ö Men√∫</button>
  </div>

  <div class="card">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <span class="text-muted" id="infoClientes"></span>
      <div>
        <button class="btn btn-primary me-2" id="btnCargar">üîÑ Actualizar</button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregar">‚ûï Nuevo Cliente</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>ID Cliente</th>
            <th>Nombre</th>
            <th>G√©nero</th>
            <th>Fecha Nac.</th>
            <th>Pa√≠s (ID)</th>
            <th>NIT</th>
            <th>Email</th>
            <th>Tel√©fono</th>
            <th>Fecha Creaci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaClientes"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Agregar -->
<div class="modal fade" id="modalAgregar" tabindex="-1" aria-labelledby="modalAgregarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formAgregar">
        <div class="modal-header">
          <h5 class="modal-title">Agregar nuevo cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" id="nombre" required>
          </div>
          <div class="mb-3">
            <label class="form-label">G√©nero</label>
            <select class="form-control" id="genero" required>
              <option value="">Seleccione...</option>
              <option value="Masculino">Masculino</option>
              <option value="Femenino">Femenino</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Fecha de Nacimiento</label>
            <input type="date" class="form-control" id="fechaNacimiento" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Pa√≠s (ID)</label>
            <input type="number" class="form-control" id="idPais" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Tel√©fono</label>
            <input type="number" class="form-control" id="telefono" required>
          </div>
          <div class="mb-3">
            <label class="form-label">NIT</label>
            <input type="text" class="form-control" id="nit">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="email">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Guardar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API = "http://localhost:8080/clientes";
  const tbody = document.getElementById("tablaClientes");
  const infoClientes = document.getElementById("infoClientes");

  async function cargarClientes() {
    tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">Cargando...</td></tr>`;
    try {
      const res = await fetch(API);
      const data = await res.json();
      tbody.innerHTML = "";

      let contador = 0;

      for (const c of data) {
        const vista = await fetch(`${API}/${c.idCliente}/vista`).then(r => r.ok ? r.json() : null);
        if (!vista) continue;

        contador++;

        tbody.innerHTML += `
          <tr>
            <td>${vista.idCliente}</td>
            <td>${vista.nombrePersona ?? vista.nombre ?? "-"}</td>
            <td>${vista.genero ?? "-"}</td>
            <td>${vista.fechaNacimiento ? vista.fechaNacimiento.slice(0,10) : "-"}</td>
            <td>${vista.idPais ?? "-"}</td>
            <td>${vista.nit ?? "-"}</td>
            <td>${vista.email ?? "-"}</td>
            <td>${vista.telefono ?? "-"}</td>
            <td>${vista.fechaCreacion ? vista.fechaCreacion.slice(0,10) : "-"}</td>
            <td>
              <button class="btn btn-secondary btn-sm" onclick="eliminarCliente(${vista.idCliente})">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }

      infoClientes.textContent = `Mostrando ${contador} cliente${contador !== 1 ? "s" : ""}.`;
    } catch {
      infoClientes.textContent = "Error al cargar clientes.";
    }
  }

  document.getElementById("formAgregar").addEventListener("submit", async e => {
    e.preventDefault();

    const generoSeleccionado = document.getElementById("genero").value === "Femenino" ? "F" : "M";

    const nuevo = {
      idPais: parseInt(document.getElementById("idPais").value),
      nombre: document.getElementById("nombre").value,
      genero: generoSeleccionado,
      fechaNacimiento: document.getElementById("fechaNacimiento").value,
      telefono: document.getElementById("telefono").value.toString(),
      nit: document.getElementById("nit").value,
      email: document.getElementById("email").value
    };

    const res = await fetch(`${API}/agregar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(nuevo)
    });

    if (res.ok) {
      alert("Cliente agregado con √©xito");
      document.getElementById("formAgregar").reset();
      const modal = bootstrap.Modal.getInstance(document.getElementById("modalAgregar"));
      modal.hide();
      cargarClientes();
    } else {
      const msg = await res.text();
      console.error("‚ùå Error:", msg);
      alert("‚ùå Error al agregar cliente");
    }
  });

  async function eliminarCliente(id) {
    if (!confirm("¬øSeguro que quieres eliminar este cliente y su persona asociada?")) return;

    try {
      const res = await fetch(`${API}/eliminar/${id}`, { method: "DELETE" });
      if (res.ok) {
        alert("‚úÖ Cliente y persona eliminados correctamente");
        cargarClientes();
      } else {
        const msg = await res.text();
        console.error("‚ùå Error:", msg);
        alert("‚ùå Error al eliminar cliente");
      }
    } catch (err) {
      console.error(err);
      alert("‚ùå Error al eliminar cliente");
    }
  }

  document.getElementById("btnCargar").addEventListener("click", cargarClientes);
  window.addEventListener("DOMContentLoaded", cargarClientes);
</script>
</body>
</html>
